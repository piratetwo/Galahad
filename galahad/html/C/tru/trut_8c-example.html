<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.17"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>C interfaces to GALAHAD TRU: trut.c</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    extensions: ["tex2jax.js"],
    jax: ["input/TeX","output/HTML-CSS"],
});
</script>
<script type="text/javascript" async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">C interfaces to GALAHAD TRU
   </div>
   <div id="projectbrief">header files for C interfaces to GALAHAD TRU package</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.17 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">trut.c</div>  </div>
</div><!--header-->
<div class="contents">
<p><a class="anchor" id="examples"></a> \(\label{examples}\)</p>
<p>This is an example of how to use the package both when the Hessian is directly available and when its product with vectors may be found. Both function call evaluations and returns to the calling program to find the required values are illustrated. A variety of supported Hessian storage formats are shown.</p>
<p>Notice that C-style indexing is used, and that this is flaggeed by setting <code>control.f_indexing</code> to <code>false</code>. In addition, see how parameters may be passed into the evaluation functions via <code>userdata</code>.<br  />
 </p><div class="fragment"><div class="line"><span class="comment">/* trut.c */</span></div>
<div class="line"><span class="comment">/* Full test for the TRU C interface using C sparse matrix indexing */</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;stdio.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;math.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &quot;<a class="code" href="tru_8h.html">tru.h</a>&quot;</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">// Custom userdata struct</span></div>
<div class="line"><span class="keyword">struct </span>userdata_type {</div>
<div class="line">   <span class="keywordtype">double</span> p;</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Function prototypes</span></div>
<div class="line"><span class="keywordtype">int</span> fun( <span class="keywordtype">int</span> n, <span class="keyword">const</span> <span class="keywordtype">double</span> x[], <span class="keywordtype">double</span> *f, <span class="keyword">const</span> <span class="keywordtype">void</span> *);</div>
<div class="line"><span class="keywordtype">int</span> grad( <span class="keywordtype">int</span> n, <span class="keyword">const</span> <span class="keywordtype">double</span> x[], <span class="keywordtype">double</span> g[], <span class="keyword">const</span> <span class="keywordtype">void</span> *);</div>
<div class="line"><span class="keywordtype">int</span> hess( <span class="keywordtype">int</span> n, <span class="keywordtype">int</span> ne, <span class="keyword">const</span> <span class="keywordtype">double</span> x[], <span class="keywordtype">double</span> hval[], <span class="keyword">const</span> <span class="keywordtype">void</span> *);</div>
<div class="line"><span class="keywordtype">int</span> hess_dense( <span class="keywordtype">int</span> n, <span class="keywordtype">int</span> ne, <span class="keyword">const</span> <span class="keywordtype">double</span> x[], <span class="keywordtype">double</span> hval[], <span class="keyword">const</span> <span class="keywordtype">void</span> *);</div>
<div class="line"><span class="keywordtype">int</span> hessprod( <span class="keywordtype">int</span> n, <span class="keyword">const</span> <span class="keywordtype">double</span> x[], <span class="keywordtype">double</span> u[], <span class="keyword">const</span> <span class="keywordtype">double</span> v[], <span class="keywordtype">bool</span> got_h,</div>
<div class="line">             <span class="keyword">const</span> <span class="keywordtype">void</span> *);</div>
<div class="line"><span class="keywordtype">int</span> prec( <span class="keywordtype">int</span> n, <span class="keyword">const</span> <span class="keywordtype">double</span> x[], <span class="keywordtype">double</span> u[], <span class="keyword">const</span> <span class="keywordtype">double</span> v[], <span class="keyword">const</span> <span class="keywordtype">void</span> *);</div>
<div class="line"><span class="keywordtype">int</span> fun_diag( <span class="keywordtype">int</span> n, <span class="keyword">const</span> <span class="keywordtype">double</span> x[], <span class="keywordtype">double</span> *f, <span class="keyword">const</span> <span class="keywordtype">void</span> *);</div>
<div class="line"><span class="keywordtype">int</span> grad_diag( <span class="keywordtype">int</span> n, <span class="keyword">const</span> <span class="keywordtype">double</span> x[], <span class="keywordtype">double</span> g[], <span class="keyword">const</span> <span class="keywordtype">void</span> *);</div>
<div class="line"><span class="keywordtype">int</span> hess_diag( <span class="keywordtype">int</span> n, <span class="keywordtype">int</span> ne, <span class="keyword">const</span> <span class="keywordtype">double</span> x[], <span class="keywordtype">double</span> hval[], <span class="keyword">const</span> <span class="keywordtype">void</span> *);</div>
<div class="line"><span class="keywordtype">int</span> hessprod_diag( <span class="keywordtype">int</span> n, <span class="keyword">const</span> <span class="keywordtype">double</span> x[], <span class="keywordtype">double</span> u[], <span class="keyword">const</span> <span class="keywordtype">double</span> v[], </div>
<div class="line">                  <span class="keywordtype">bool</span> got_h, <span class="keyword">const</span> <span class="keywordtype">void</span> *);</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">int</span> main(<span class="keywordtype">void</span>) {</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// Derived types</span></div>
<div class="line">    <span class="keywordtype">void</span> *data;</div>
<div class="line">    <span class="keyword">struct </span><a name="_a0"></a><a class="code" href="structtru__control__type.html">tru_control_type</a> control;</div>
<div class="line">    <span class="keyword">struct </span><a name="_a1"></a><a class="code" href="structtru__inform__type.html">tru_inform_type</a> inform;</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// Set user data</span></div>
<div class="line">    <span class="keyword">struct </span>userdata_type userdata;</div>
<div class="line">    userdata.p = 4.0;</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// Set problem data</span></div>
<div class="line">    <span class="keywordtype">int</span> n = 3; <span class="comment">// dimension</span></div>
<div class="line">    <span class="keywordtype">int</span> ne = 5; <span class="comment">// Hesssian elements</span></div>
<div class="line">    <span class="keywordtype">int</span> H_row[] = {0, 1, 2, 2, 2}; <span class="comment">// Hessian H</span></div>
<div class="line">    <span class="keywordtype">int</span> H_col[] = {0, 1, 0, 1, 2}; <span class="comment">// NB lower triangle</span></div>
<div class="line">    <span class="keywordtype">int</span> H_ptr[] = {0, 1, 2, 5};    <span class="comment">// row pointers</span></div>
<div class="line"> </div>
<div class="line">    <span class="comment">// Set storage</span></div>
<div class="line">    <span class="keywordtype">double</span> g[n]; <span class="comment">// gradient</span></div>
<div class="line">    <span class="keywordtype">char</span> st;</div>
<div class="line">    <span class="keywordtype">int</span> status;</div>
<div class="line"> </div>
<div class="line">    printf(<span class="stringliteral">&quot; C sparse matrix indexing\n\n&quot;</span>);</div>
<div class="line"> </div>
<div class="line">    printf(<span class="stringliteral">&quot; tests options for all-in-one storage format\n\n&quot;</span>);</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">for</span>( <span class="keywordtype">int</span> d=1; d &lt;= 5; d++){</div>
<div class="line"> </div>
<div class="line">        <span class="comment">// Initialize TRU</span></div>
<div class="line">        <a name="a2"></a><a class="code" href="tru_8h.html#a1ae7a579fa70c63d8dc62566c04d9aff">tru_initialize</a>( &amp;data, &amp;control, &amp;inform );</div>
<div class="line"> </div>
<div class="line">        <span class="comment">// Set user-defined control options</span></div>
<div class="line">        control.f_indexing = <span class="keyword">false</span>; <span class="comment">// C sparse matrix indexing</span></div>
<div class="line">        <span class="comment">//control.print_level = 1;</span></div>
<div class="line"> </div>
<div class="line">        <span class="comment">// Start from 1.5</span></div>
<div class="line">        <span class="keywordtype">double</span> x[] = {1.5,1.5,1.5}; </div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">switch</span>(d){</div>
<div class="line">            <span class="keywordflow">case</span> 1: <span class="comment">// sparse co-ordinate storage</span></div>
<div class="line">                st = <span class="charliteral">&#39;C&#39;</span>;</div>
<div class="line">                <span class="comment">// control.print_level = 1;</span></div>
<div class="line">                <a name="a3"></a><a class="code" href="tru_8h.html#a8175a402569a69faa351e2dcd3c48b94">tru_import</a>( &amp;control, &amp;data, &amp;status, n, <span class="stringliteral">&quot;coordinate&quot;</span>, </div>
<div class="line">                            ne, H_row, H_col, NULL );</div>
<div class="line">                <a name="a4"></a><a class="code" href="tru_8h.html#a638a31d7027eaf1ae39aa7278e7c5c5a">tru_solve_with_mat</a>( &amp;data, &amp;userdata, &amp;status,</div>
<div class="line">                                    n, x, g, ne, fun, grad, hess, prec );</div>
<div class="line">                <span class="keywordflow">break</span>;</div>
<div class="line">            <span class="keywordflow">case</span> 2: <span class="comment">// sparse by rows  </span></div>
<div class="line">                st = <span class="charliteral">&#39;R&#39;</span>;</div>
<div class="line">                <a class="code" href="tru_8h.html#a8175a402569a69faa351e2dcd3c48b94">tru_import</a>( &amp;control, &amp;data, &amp;status, n, <span class="stringliteral">&quot;sparse_by_rows&quot;</span>, </div>
<div class="line">                           ne, NULL, H_col, H_ptr);</div>
<div class="line">                <a class="code" href="tru_8h.html#a638a31d7027eaf1ae39aa7278e7c5c5a">tru_solve_with_mat</a>( &amp;data, &amp;userdata, &amp;status,</div>
<div class="line">                                    n, x, g, ne, fun, grad, hess, prec );</div>
<div class="line">                <span class="keywordflow">break</span>;</div>
<div class="line">            <span class="keywordflow">case</span> 3: <span class="comment">// dense</span></div>
<div class="line">                st = <span class="charliteral">&#39;D&#39;</span>;</div>
<div class="line">                <a class="code" href="tru_8h.html#a8175a402569a69faa351e2dcd3c48b94">tru_import</a>( &amp;control, &amp;data, &amp;status, n, <span class="stringliteral">&quot;dense&quot;</span>, </div>
<div class="line">                            ne, NULL, NULL, NULL );</div>
<div class="line">                <a class="code" href="tru_8h.html#a638a31d7027eaf1ae39aa7278e7c5c5a">tru_solve_with_mat</a>( &amp;data, &amp;userdata, &amp;status,</div>
<div class="line">                                    n, x, g, ne, fun, grad, hess_dense, prec );</div>
<div class="line">                <span class="keywordflow">break</span>;</div>
<div class="line">            <span class="keywordflow">case</span> 4: <span class="comment">// diagonal</span></div>
<div class="line">                st = <span class="charliteral">&#39;I&#39;</span>;</div>
<div class="line">                <a class="code" href="tru_8h.html#a8175a402569a69faa351e2dcd3c48b94">tru_import</a>( &amp;control, &amp;data, &amp;status, n, <span class="stringliteral">&quot;diagonal&quot;</span>, </div>
<div class="line">                            ne, NULL, NULL, NULL );</div>
<div class="line">                <a class="code" href="tru_8h.html#a638a31d7027eaf1ae39aa7278e7c5c5a">tru_solve_with_mat</a>( &amp;data, &amp;userdata, &amp;status, n, x, g, </div>
<div class="line">                                    ne, fun_diag, grad_diag, hess_diag, prec );</div>
<div class="line">                <span class="keywordflow">break</span>;</div>
<div class="line">            <span class="keywordflow">case</span> 5: <span class="comment">// access by products</span></div>
<div class="line">                st = <span class="charliteral">&#39;P&#39;</span>;</div>
<div class="line">                <a class="code" href="tru_8h.html#a8175a402569a69faa351e2dcd3c48b94">tru_import</a>( &amp;control, &amp;data, &amp;status, n, <span class="stringliteral">&quot;absent&quot;</span>, </div>
<div class="line">                            ne, NULL, NULL, NULL );</div>
<div class="line">                <a name="a5"></a><a class="code" href="tru_8h.html#aaa508227d17d8da723bb0401023acd96">tru_solve_without_mat</a>( &amp;data, &amp;userdata, &amp;status,</div>
<div class="line">                                       n, x, g, fun, grad, hessprod, prec );</div>
<div class="line">                <span class="keywordflow">break</span>;</div>
<div class="line">        }</div>
<div class="line">        <a name="a6"></a><a class="code" href="tru_8h.html#a7c756ce759b44ddbd1ffac77bf497e5a">tru_information</a>( &amp;data, &amp;inform, &amp;status );</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">if</span>(inform.status == 0){</div>
<div class="line">            printf(<span class="stringliteral">&quot;%c:%6i iterations. Optimal objective value = %5.2f status = %1i\n&quot;</span>, </div>
<div class="line">                   st, inform.iter, inform.obj, inform.status);</div>
<div class="line">        }<span class="keywordflow">else</span>{</div>
<div class="line">            printf(<span class="stringliteral">&quot;%c: TRU_solve exit status = %1i\n&quot;</span>, st, inform.status);</div>
<div class="line">        }</div>
<div class="line">        <span class="comment">//printf(&quot;x: &quot;);</span></div>
<div class="line">        <span class="comment">//for( int i = 0; i &lt; n; i++) printf(&quot;%f &quot;, x[i]);</span></div>
<div class="line">        <span class="comment">//printf(&quot;\n&quot;);</span></div>
<div class="line">        <span class="comment">//printf(&quot;gradient: &quot;);</span></div>
<div class="line">        <span class="comment">//for( int i = 0; i &lt; n; i++) printf(&quot;%f &quot;, g[i]);</span></div>
<div class="line">        <span class="comment">//printf(&quot;\n&quot;);</span></div>
<div class="line"> </div>
<div class="line">        <span class="comment">// Delete internal workspace</span></div>
<div class="line">        <a name="a7"></a><a class="code" href="tru_8h.html#aa38f8880b4f63e610ae1f269353ac46e">tru_terminate</a>( &amp;data, &amp;control, &amp;inform );</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    printf(<span class="stringliteral">&quot;\n tests reverse-communication options\n\n&quot;</span>);</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// reverse-communication input/output</span></div>
<div class="line">    <span class="keywordtype">int</span> eval_status;</div>
<div class="line">    <span class="keywordtype">double</span> f;</div>
<div class="line">    <span class="keywordtype">double</span> u[n], v[n];</div>
<div class="line">    <span class="keywordtype">int</span> index_nz_u[n], index_nz_v[n];</div>
<div class="line">    <span class="keywordtype">double</span> H_val[ne], H_dense[n*(n+1)/2], H_diag[n];</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">for</span>( <span class="keywordtype">int</span> d=1; d &lt;= 5; d++){</div>
<div class="line"> </div>
<div class="line">        <span class="comment">// Initialize TRU</span></div>
<div class="line">        <a class="code" href="tru_8h.html#a1ae7a579fa70c63d8dc62566c04d9aff">tru_initialize</a>( &amp;data, &amp;control, &amp;inform );</div>
<div class="line"> </div>
<div class="line">        <span class="comment">// Set user-defined control options</span></div>
<div class="line">        control.f_indexing = <span class="keyword">false</span>; <span class="comment">// C sparse matrix indexing</span></div>
<div class="line">        <span class="comment">//control.print_level = 1;</span></div>
<div class="line"> </div>
<div class="line">        <span class="comment">// Start from 1.5</span></div>
<div class="line">        <span class="keywordtype">double</span> x[] = {1.5,1.5,1.5}; </div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">switch</span>(d){</div>
<div class="line">            <span class="keywordflow">case</span> 1: <span class="comment">// sparse co-ordinate storage</span></div>
<div class="line">                st = <span class="charliteral">&#39;C&#39;</span>;</div>
<div class="line">                <a class="code" href="tru_8h.html#a8175a402569a69faa351e2dcd3c48b94">tru_import</a>( &amp;control, &amp;data, &amp;status, n, <span class="stringliteral">&quot;coordinate&quot;</span>, </div>
<div class="line">                            ne, H_row, H_col, NULL );</div>
<div class="line">                <span class="keywordflow">while</span>(<span class="keyword">true</span>){ <span class="comment">// reverse-communication loop</span></div>
<div class="line">                    <a name="a8"></a><a class="code" href="tru_8h.html#a804863856294e362b724fca8953300d5">tru_solve_reverse_with_mat</a>( &amp;data, &amp;status, &amp;eval_status, </div>
<div class="line">                                                n, x, f, g, ne, H_val, u, v );</div>
<div class="line">                    <span class="keywordflow">if</span>(status == 0){ <span class="comment">// successful termination</span></div>
<div class="line">                        <span class="keywordflow">break</span>;</div>
<div class="line">                    }<span class="keywordflow">else</span> <span class="keywordflow">if</span>(status &lt; 0){ <span class="comment">// error exit</span></div>
<div class="line">                        <span class="keywordflow">break</span>;</div>
<div class="line">                    }<span class="keywordflow">else</span> <span class="keywordflow">if</span>(status == 2){ <span class="comment">// evaluate f</span></div>
<div class="line">                        eval_status = fun( n, x, &amp;f, &amp;userdata );</div>
<div class="line">                    }<span class="keywordflow">else</span> <span class="keywordflow">if</span>(status == 3){ <span class="comment">// evaluate g</span></div>
<div class="line">                        eval_status = grad( n, x, g, &amp;userdata );</div>
<div class="line">                    }<span class="keywordflow">else</span> <span class="keywordflow">if</span>(status == 4){ <span class="comment">// evaluate H</span></div>
<div class="line">                        eval_status = hess( n, ne, x, H_val, &amp;userdata ); </div>
<div class="line">                    }<span class="keywordflow">else</span> <span class="keywordflow">if</span>(status == 6){ <span class="comment">// evaluate the product with P</span></div>
<div class="line">                        eval_status = prec( n, x, u, v, &amp;userdata );</div>
<div class="line">                    }<span class="keywordflow">else</span>{</div>
<div class="line">                        printf(<span class="stringliteral">&quot; the value %1i of status should not occur\n&quot;</span>, </div>
<div class="line">                          status);</div>
<div class="line">                        <span class="keywordflow">break</span>;</div>
<div class="line">                    }</div>
<div class="line">                }</div>
<div class="line">                <span class="keywordflow">break</span>;</div>
<div class="line">            <span class="keywordflow">case</span> 2: <span class="comment">// sparse by rows  </span></div>
<div class="line">                st = <span class="charliteral">&#39;R&#39;</span>;</div>
<div class="line">                <a class="code" href="tru_8h.html#a8175a402569a69faa351e2dcd3c48b94">tru_import</a>( &amp;control, &amp;data, &amp;status, n, <span class="stringliteral">&quot;sparse_by_rows&quot;</span>, ne, </div>
<div class="line">                            NULL, H_col, H_ptr );</div>
<div class="line">                <span class="keywordflow">while</span>(<span class="keyword">true</span>){ <span class="comment">// reverse-communication loop</span></div>
<div class="line">                    <a class="code" href="tru_8h.html#a804863856294e362b724fca8953300d5">tru_solve_reverse_with_mat</a>( &amp;data, &amp;status, &amp;eval_status, </div>
<div class="line">                                                n, x, f, g, ne, H_val, u, v );</div>
<div class="line">                    <span class="keywordflow">if</span>(status == 0){ <span class="comment">// successful termination</span></div>
<div class="line">                        <span class="keywordflow">break</span>;</div>
<div class="line">                    }<span class="keywordflow">else</span> <span class="keywordflow">if</span>(status &lt; 0){ <span class="comment">// error exit</span></div>
<div class="line">                        <span class="keywordflow">break</span>;</div>
<div class="line">                    }<span class="keywordflow">else</span> <span class="keywordflow">if</span>(status == 2){ <span class="comment">// evaluate f</span></div>
<div class="line">                        eval_status = fun( n, x, &amp;f, &amp;userdata );</div>
<div class="line">                    }<span class="keywordflow">else</span> <span class="keywordflow">if</span>(status == 3){ <span class="comment">// evaluate g</span></div>
<div class="line">                        eval_status = grad( n, x, g, &amp;userdata );</div>
<div class="line">                    }<span class="keywordflow">else</span> <span class="keywordflow">if</span>(status == 4){ <span class="comment">// evaluate H</span></div>
<div class="line">                        eval_status = hess( n, ne, x, H_val, &amp;userdata ); </div>
<div class="line">                    }<span class="keywordflow">else</span> <span class="keywordflow">if</span>(status == 6){ <span class="comment">// evaluate the product with P</span></div>
<div class="line">                        eval_status = prec( n, x, u, v, &amp;userdata );</div>
<div class="line">                    }<span class="keywordflow">else</span>{</div>
<div class="line">                        printf(<span class="stringliteral">&quot; the value %1i of status should not occur\n&quot;</span>, </div>
<div class="line">                          status);</div>
<div class="line">                        <span class="keywordflow">break</span>;</div>
<div class="line">                    }</div>
<div class="line">                }</div>
<div class="line">                <span class="keywordflow">break</span>;</div>
<div class="line">            <span class="keywordflow">case</span> 3: <span class="comment">// dense</span></div>
<div class="line">                st = <span class="charliteral">&#39;D&#39;</span>;</div>
<div class="line">                <a class="code" href="tru_8h.html#a8175a402569a69faa351e2dcd3c48b94">tru_import</a>( &amp;control, &amp;data, &amp;status, n, <span class="stringliteral">&quot;dense&quot;</span>, </div>
<div class="line">                            ne, NULL, NULL, NULL );</div>
<div class="line">                <span class="keywordflow">while</span>(<span class="keyword">true</span>){ <span class="comment">// reverse-communication loop</span></div>
<div class="line">                    <a class="code" href="tru_8h.html#a804863856294e362b724fca8953300d5">tru_solve_reverse_with_mat</a>( &amp;data, &amp;status, &amp;eval_status, </div>
<div class="line">                                         n, x, f, g, n*(n+1)/2, H_dense, u, v );</div>
<div class="line">                    <span class="keywordflow">if</span>(status == 0){ <span class="comment">// successful termination</span></div>
<div class="line">                        <span class="keywordflow">break</span>;</div>
<div class="line">                    }<span class="keywordflow">else</span> <span class="keywordflow">if</span>(status &lt; 0){ <span class="comment">// error exit</span></div>
<div class="line">                        <span class="keywordflow">break</span>;</div>
<div class="line">                    }<span class="keywordflow">else</span> <span class="keywordflow">if</span>(status == 2){ <span class="comment">// evaluate f</span></div>
<div class="line">                        eval_status = fun( n, x, &amp;f, &amp;userdata );</div>
<div class="line">                    }<span class="keywordflow">else</span> <span class="keywordflow">if</span>(status == 3){ <span class="comment">// evaluate g</span></div>
<div class="line">                        eval_status = grad( n, x, g, &amp;userdata );</div>
<div class="line">                    }<span class="keywordflow">else</span> <span class="keywordflow">if</span>(status == 4){ <span class="comment">// evaluate H</span></div>
<div class="line">                        eval_status = hess_dense( n, n*( n+1)/2, x, H_dense, </div>
<div class="line">                                                 &amp;userdata ); </div>
<div class="line">                    }<span class="keywordflow">else</span> <span class="keywordflow">if</span>(status == 6){ <span class="comment">// evaluate the product with P</span></div>
<div class="line">                        eval_status = prec( n, x, u, v, &amp;userdata );</div>
<div class="line">                    }<span class="keywordflow">else</span>{</div>
<div class="line">                        printf(<span class="stringliteral">&quot; the value %1i of status should not occur\n&quot;</span>, </div>
<div class="line">                          status);</div>
<div class="line">                        <span class="keywordflow">break</span>;</div>
<div class="line">                    }</div>
<div class="line">                }</div>
<div class="line">                <span class="keywordflow">break</span>;</div>
<div class="line">            <span class="keywordflow">case</span> 4: <span class="comment">// diagonal</span></div>
<div class="line">                st = <span class="charliteral">&#39;I&#39;</span>;</div>
<div class="line">                <a class="code" href="tru_8h.html#a8175a402569a69faa351e2dcd3c48b94">tru_import</a>( &amp;control, &amp;data, &amp;status, n, <span class="stringliteral">&quot;diagonal&quot;</span>, </div>
<div class="line">                           ne, NULL, NULL, NULL );</div>
<div class="line">                <span class="keywordflow">while</span>(<span class="keyword">true</span>){ <span class="comment">// reverse-communication loop</span></div>
<div class="line">                    <a class="code" href="tru_8h.html#a804863856294e362b724fca8953300d5">tru_solve_reverse_with_mat</a>( &amp;data, &amp;status, &amp;eval_status, </div>
<div class="line">                                                n, x, f, g, n, H_diag, u, v );</div>
<div class="line">                    <span class="keywordflow">if</span>(status == 0){ <span class="comment">// successful termination</span></div>
<div class="line">                        <span class="keywordflow">break</span>;</div>
<div class="line">                    }<span class="keywordflow">else</span> <span class="keywordflow">if</span>(status &lt; 0){ <span class="comment">// error exit</span></div>
<div class="line">                        <span class="keywordflow">break</span>;</div>
<div class="line">                    }<span class="keywordflow">else</span> <span class="keywordflow">if</span>(status == 2){ <span class="comment">// evaluate f</span></div>
<div class="line">                        eval_status = fun_diag( n, x, &amp;f, &amp;userdata );</div>
<div class="line">                    }<span class="keywordflow">else</span> <span class="keywordflow">if</span>(status == 3){ <span class="comment">// evaluate g</span></div>
<div class="line">                        eval_status = grad_diag( n, x, g, &amp;userdata );</div>
<div class="line">                    }<span class="keywordflow">else</span> <span class="keywordflow">if</span>(status == 4){ <span class="comment">// evaluate H</span></div>
<div class="line">                        eval_status = hess_diag( n, n, x, H_diag, &amp;userdata ); </div>
<div class="line">                    }<span class="keywordflow">else</span> <span class="keywordflow">if</span>(status == 6){ <span class="comment">// evaluate the product with P</span></div>
<div class="line">                        eval_status = prec( n, x, u, v, &amp;userdata );</div>
<div class="line">                    }<span class="keywordflow">else</span>{</div>
<div class="line">                        printf(<span class="stringliteral">&quot; the value %1i of status should not occur\n&quot;</span>, </div>
<div class="line">                          status);</div>
<div class="line">                        <span class="keywordflow">break</span>;</div>
<div class="line">                    }</div>
<div class="line">                }</div>
<div class="line">                <span class="keywordflow">break</span>;</div>
<div class="line">            <span class="keywordflow">case</span> 5: <span class="comment">// access by products</span></div>
<div class="line">                st = <span class="charliteral">&#39;P&#39;</span>;</div>
<div class="line">                <a class="code" href="tru_8h.html#a8175a402569a69faa351e2dcd3c48b94">tru_import</a>( &amp;control, &amp;data, &amp;status, n, <span class="stringliteral">&quot;absent&quot;</span>, </div>
<div class="line">                            ne, NULL, NULL, NULL );</div>
<div class="line">                <span class="keywordflow">while</span>(<span class="keyword">true</span>){ <span class="comment">// reverse-communication loop</span></div>
<div class="line">                    <a name="a9"></a><a class="code" href="tru_8h.html#a97252b83eaab0b4d5d3ac53e6b317206">tru_solve_reverse_without_mat</a>( &amp;data, &amp;status, &amp;eval_status,</div>
<div class="line">                                                   n, x, f, g, u, v );</div>
<div class="line">                    <span class="keywordflow">if</span>(status == 0){ <span class="comment">// successful termination</span></div>
<div class="line">                        <span class="keywordflow">break</span>;</div>
<div class="line">                    }<span class="keywordflow">else</span> <span class="keywordflow">if</span>(status &lt; 0){ <span class="comment">// error exit</span></div>
<div class="line">                        <span class="keywordflow">break</span>;</div>
<div class="line">                    }<span class="keywordflow">else</span> <span class="keywordflow">if</span>(status == 2){ <span class="comment">// evaluate f</span></div>
<div class="line">                        eval_status = fun( n, x, &amp;f, &amp;userdata );</div>
<div class="line">                    }<span class="keywordflow">else</span> <span class="keywordflow">if</span>(status == 3){ <span class="comment">// evaluate g</span></div>
<div class="line">                        eval_status = grad( n, x, g, &amp;userdata );</div>
<div class="line">                    }<span class="keywordflow">else</span> <span class="keywordflow">if</span>(status == 5){ <span class="comment">// evaluate H</span></div>
<div class="line">                        eval_status = hessprod( n, x, u, v, <span class="keyword">false</span>, &amp;userdata );</div>
<div class="line">                    }<span class="keywordflow">else</span> <span class="keywordflow">if</span>(status == 6){ <span class="comment">// evaluate the product with P</span></div>
<div class="line">                        eval_status = prec( n, x, u, v, &amp;userdata );</div>
<div class="line">                    }<span class="keywordflow">else</span>{</div>
<div class="line">                        printf(<span class="stringliteral">&quot; the value %1i of status should not occur\n&quot;</span>, </div>
<div class="line">                          status);</div>
<div class="line">                        <span class="keywordflow">break</span>;</div>
<div class="line">                    }</div>
<div class="line">                }</div>
<div class="line">                <span class="keywordflow">break</span>;</div>
<div class="line">        }</div>
<div class="line">        <a class="code" href="tru_8h.html#a7c756ce759b44ddbd1ffac77bf497e5a">tru_information</a>( &amp;data, &amp;inform, &amp;status );</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">if</span>(inform.status == 0){</div>
<div class="line">            printf(<span class="stringliteral">&quot;%c:%6i iterations. Optimal objective value = %5.2f status = %1i\n&quot;</span>, </div>
<div class="line">                   st, inform.iter, inform.obj, inform.status);</div>
<div class="line">        }<span class="keywordflow">else</span>{</div>
<div class="line">            printf(<span class="stringliteral">&quot;%c: TRU_solve exit status = %1i\n&quot;</span>, st, inform.status);</div>
<div class="line">        }</div>
<div class="line">        <span class="comment">//printf(&quot;x: &quot;);</span></div>
<div class="line">        <span class="comment">//for( int i = 0; i &lt; n; i++) printf(&quot;%f &quot;, x[i]);</span></div>
<div class="line">        <span class="comment">//printf(&quot;\n&quot;);</span></div>
<div class="line">        <span class="comment">//printf(&quot;gradient: &quot;);</span></div>
<div class="line">        <span class="comment">//for( int i = 0; i &lt; n; i++) printf(&quot;%f &quot;, g[i]);</span></div>
<div class="line">        <span class="comment">//printf(&quot;\n&quot;);</span></div>
<div class="line"> </div>
<div class="line">        <span class="comment">// Delete internal workspace</span></div>
<div class="line">        <a class="code" href="tru_8h.html#aa38f8880b4f63e610ae1f269353ac46e">tru_terminate</a>( &amp;data, &amp;control, &amp;inform );</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Objective function </span></div>
<div class="line"><span class="keywordtype">int</span> fun( <span class="keywordtype">int</span> n, <span class="keyword">const</span> <span class="keywordtype">double</span> x[], <span class="keywordtype">double</span> *f, <span class="keyword">const</span> <span class="keywordtype">void</span> *userdata ){</div>
<div class="line">    <span class="keyword">struct </span>userdata_type *myuserdata = (<span class="keyword">struct </span>userdata_type *) userdata;</div>
<div class="line">    <span class="keywordtype">double</span> p = myuserdata-&gt;p;</div>
<div class="line"> </div>
<div class="line">    *f = pow(x[0] + x[2] + p, 2) + pow(x[1] + x[2], 2) + cos(x[0]);</div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Gradient of the objective</span></div>
<div class="line"><span class="keywordtype">int</span> grad( <span class="keywordtype">int</span> n, <span class="keyword">const</span> <span class="keywordtype">double</span> x[], <span class="keywordtype">double</span> g[], <span class="keyword">const</span> <span class="keywordtype">void</span> *userdata ){</div>
<div class="line">    <span class="keyword">struct </span>userdata_type *myuserdata = (<span class="keyword">struct </span>userdata_type *) userdata;</div>
<div class="line">    <span class="keywordtype">double</span> p = myuserdata-&gt;p;</div>
<div class="line"> </div>
<div class="line">    g[0] = 2.0 * ( x[0] + x[2] + p ) - sin(x[0]);</div>
<div class="line">    g[1] = 2.0 * ( x[1] + x[2] );</div>
<div class="line">    g[2] = 2.0 * ( x[0] + x[2] + p ) + 2.0 * ( x[1] + x[2] );</div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Hessian of the objective</span></div>
<div class="line"><span class="keywordtype">int</span> hess( <span class="keywordtype">int</span> n, <span class="keywordtype">int</span> ne, <span class="keyword">const</span> <span class="keywordtype">double</span> x[], <span class="keywordtype">double</span> hval[], </div>
<div class="line">         <span class="keyword">const</span> <span class="keywordtype">void</span> *userdata ){</div>
<div class="line">    hval[0] = 2.0 - cos(x[0]);</div>
<div class="line">    hval[1] = 2.0;</div>
<div class="line">    hval[2] = 2.0;</div>
<div class="line">    hval[3] = 2.0;</div>
<div class="line">    hval[4] = 4.0;</div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Dense Hessian</span></div>
<div class="line"><span class="keywordtype">int</span> hess_dense( <span class="keywordtype">int</span> n, <span class="keywordtype">int</span> ne, <span class="keyword">const</span> <span class="keywordtype">double</span> x[], <span class="keywordtype">double</span> hval[], </div>
<div class="line">               <span class="keyword">const</span> <span class="keywordtype">void</span> *userdata ){ </div>
<div class="line">    hval[0] = 2.0 - cos(x[0]);</div>
<div class="line">    hval[1] = 0.0;</div>
<div class="line">    hval[2] = 2.0;</div>
<div class="line">    hval[3] = 2.0;</div>
<div class="line">    hval[4] = 2.0;</div>
<div class="line">    hval[5] = 4.0;</div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Hessian-vector product</span></div>
<div class="line"><span class="keywordtype">int</span> hessprod( <span class="keywordtype">int</span> n, <span class="keyword">const</span> <span class="keywordtype">double</span> x[], <span class="keywordtype">double</span> u[], <span class="keyword">const</span> <span class="keywordtype">double</span> v[], </div>
<div class="line">             <span class="keywordtype">bool</span> got_h, <span class="keyword">const</span> <span class="keywordtype">void</span> *userdata ){</div>
<div class="line">    u[0] = u[0] + 2.0 * ( v[0] + v[2] ) - cos(x[0]) * v[0];</div>
<div class="line">    u[1] = u[1] + 2.0 * ( v[1] + v[2] );</div>
<div class="line">    u[2] = u[2] + 2.0 * ( v[0] + v[1] + 2.0 * v[2] );</div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Apply preconditioner</span></div>
<div class="line"><span class="keywordtype">int</span> prec( <span class="keywordtype">int</span> n, <span class="keyword">const</span> <span class="keywordtype">double</span> x[], <span class="keywordtype">double</span> u[], <span class="keyword">const</span> <span class="keywordtype">double</span> v[], </div>
<div class="line">         <span class="keyword">const</span> <span class="keywordtype">void</span> *userdata ){</div>
<div class="line">   u[0] = 0.5 * v[0];</div>
<div class="line">   u[1] = 0.5 * v[1];</div>
<div class="line">   u[2] = 0.25 * v[2];</div>
<div class="line">   <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"> <span class="comment">// Objective function </span></div>
<div class="line"><span class="keywordtype">int</span> fun_diag( <span class="keywordtype">int</span> n, <span class="keyword">const</span> <span class="keywordtype">double</span> x[], <span class="keywordtype">double</span> *f, <span class="keyword">const</span> <span class="keywordtype">void</span> *userdata ){</div>
<div class="line">    <span class="keyword">struct </span>userdata_type *myuserdata = (<span class="keyword">struct </span>userdata_type *) userdata;</div>
<div class="line">    <span class="keywordtype">double</span> p = myuserdata-&gt;p;</div>
<div class="line"> </div>
<div class="line">    *f = pow(x[2] + p, 2) + pow(x[1], 2) + cos(x[0]);</div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Gradient of the objective</span></div>
<div class="line"><span class="keywordtype">int</span> grad_diag( <span class="keywordtype">int</span> n, <span class="keyword">const</span> <span class="keywordtype">double</span> x[], <span class="keywordtype">double</span> g[], <span class="keyword">const</span> <span class="keywordtype">void</span> *userdata ){</div>
<div class="line">    <span class="keyword">struct </span>userdata_type *myuserdata = (<span class="keyword">struct </span>userdata_type *) userdata;</div>
<div class="line">    <span class="keywordtype">double</span> p = myuserdata-&gt;p;</div>
<div class="line"> </div>
<div class="line">    g[0] = -sin(x[0]);</div>
<div class="line">    g[1] = 2.0 * x[1];</div>
<div class="line">    g[2] = 2.0 * ( x[2] + p );</div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Hessian of the objective</span></div>
<div class="line"><span class="keywordtype">int</span> hess_diag( <span class="keywordtype">int</span> n, <span class="keywordtype">int</span> ne, <span class="keyword">const</span> <span class="keywordtype">double</span> x[], <span class="keywordtype">double</span> hval[], </div>
<div class="line">               <span class="keyword">const</span> <span class="keywordtype">void</span> *userdata ){</div>
<div class="line">    hval[0] = -cos(x[0]);</div>
<div class="line">    hval[1] = 2.0;</div>
<div class="line">    hval[2] = 2.0;</div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}  </div>
<div class="line"> </div>
<div class="line"><span class="comment">// Hessian-vector product</span></div>
<div class="line"><span class="keywordtype">int</span> hessprod_diag( <span class="keywordtype">int</span> n, <span class="keyword">const</span> <span class="keywordtype">double</span> x[], <span class="keywordtype">double</span> u[], <span class="keyword">const</span> <span class="keywordtype">double</span> v[], </div>
<div class="line">                  <span class="keywordtype">bool</span> got_h, <span class="keyword">const</span> <span class="keywordtype">void</span> *userdata ){</div>
<div class="line">    u[0] = u[0] + - cos(x[0]) * v[0];</div>
<div class="line">    u[1] = u[1] + 2.0 * v[1];</div>
<div class="line">    u[2] = u[2] + 2.0 * v[2];</div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
</div><!-- fragment --> </div><!-- contents -->
<div class="ttc" id="atru_8h_html_a8175a402569a69faa351e2dcd3c48b94"><div class="ttname"><a href="tru_8h.html#a8175a402569a69faa351e2dcd3c48b94">tru_import</a></div><div class="ttdeci">void tru_import(struct tru_control_type *control, void **data, int *status, int n, const char H_type[], int ne, const int H_row[], const int H_col[], const int H_ptr[])</div></div>
<div class="ttc" id="atru_8h_html_a1ae7a579fa70c63d8dc62566c04d9aff"><div class="ttname"><a href="tru_8h.html#a1ae7a579fa70c63d8dc62566c04d9aff">tru_initialize</a></div><div class="ttdeci">void tru_initialize(void **data, struct tru_control_type *control, struct tru_inform_type *inform)</div></div>
<div class="ttc" id="atru_8h_html_a804863856294e362b724fca8953300d5"><div class="ttname"><a href="tru_8h.html#a804863856294e362b724fca8953300d5">tru_solve_reverse_with_mat</a></div><div class="ttdeci">void tru_solve_reverse_with_mat(void **data, int *status, int *eval_status, int n, real_wp_ x[], real_wp_ f, real_wp_ g[], int ne, real_wp_ H_val[], const real_wp_ u[], real_wp_ v[])</div></div>
<div class="ttc" id="atru_8h_html_a638a31d7027eaf1ae39aa7278e7c5c5a"><div class="ttname"><a href="tru_8h.html#a638a31d7027eaf1ae39aa7278e7c5c5a">tru_solve_with_mat</a></div><div class="ttdeci">void tru_solve_with_mat(void **data, void *userdata, int *status, int n, real_wp_ x[], real_wp_ g[], int ne, int(*eval_f)(int, const real_wp_[], real_wp_ *, const void *), int(*eval_g)(int, const real_wp_[], real_wp_[], const void *), int(*eval_h)(int, int, const real_wp_[], real_wp_[], const void *), int(*eval_prec)(int, const real_wp_[], real_wp_[], const real_wp_[], const void *))</div></div>
<div class="ttc" id="astructtru__inform__type_html"><div class="ttname"><a href="structtru__inform__type.html">tru_inform_type</a></div><div class="ttdef"><b>Definition:</b> tru.h:496</div></div>
<div class="ttc" id="atru_8h_html"><div class="ttname"><a href="tru_8h.html">tru.h</a></div></div>
<div class="ttc" id="atru_8h_html_a97252b83eaab0b4d5d3ac53e6b317206"><div class="ttname"><a href="tru_8h.html#a97252b83eaab0b4d5d3ac53e6b317206">tru_solve_reverse_without_mat</a></div><div class="ttdeci">void tru_solve_reverse_without_mat(void **data, int *status, int *eval_status, int n, real_wp_ x[], real_wp_ f, real_wp_ g[], real_wp_ u[], real_wp_ v[])</div></div>
<div class="ttc" id="atru_8h_html_aa38f8880b4f63e610ae1f269353ac46e"><div class="ttname"><a href="tru_8h.html#aa38f8880b4f63e610ae1f269353ac46e">tru_terminate</a></div><div class="ttdeci">void tru_terminate(void **data, struct tru_control_type *control, struct tru_inform_type *inform)</div></div>
<div class="ttc" id="astructtru__control__type_html"><div class="ttname"><a href="structtru__control__type.html">tru_control_type</a></div><div class="ttdef"><b>Definition:</b> tru.h:215</div></div>
<div class="ttc" id="atru_8h_html_a7c756ce759b44ddbd1ffac77bf497e5a"><div class="ttname"><a href="tru_8h.html#a7c756ce759b44ddbd1ffac77bf497e5a">tru_information</a></div><div class="ttdeci">void tru_information(void **data, struct tru_inform_type *inform, int *status)</div></div>
<div class="ttc" id="atru_8h_html_aaa508227d17d8da723bb0401023acd96"><div class="ttname"><a href="tru_8h.html#aaa508227d17d8da723bb0401023acd96">tru_solve_without_mat</a></div><div class="ttdeci">void tru_solve_without_mat(void **data, void *userdata, int *status, int n, real_wp_ x[], real_wp_ g[], int(*eval_f)(int, const real_wp_[], real_wp_ *, const void *), int(*eval_g)(int, const real_wp_[], real_wp_[], const void *), int(*eval_hprod)(int, const real_wp_[], real_wp_[], const real_wp_[], bool, const void *), int(*eval_prec)(int, const real_wp_[], real_wp_[], const real_wp_[], const void *))</div></div>
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.17
</small></address>
</body>
</html>
